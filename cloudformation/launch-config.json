{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "Stage": {
            "Description": "Stage name",
            "Type": "String",
            "Default": "PROD"
        },
        "SecurityGroups" : {
            "Description" : "The Security Groups to launch the instance with",
            "Type" : "CommaDelimitedList"
        },
        "InstanceProfile": {
            "Description": "The name or ARN of the instance profile to use",
            "Type": "String"
        }
    },
    "Resources": {
        "LaunchConfig": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",

            "Properties": {
                "ImageId": "ami-aa0d49dd",
                "AssociatePublicIpAddress": true,
                "SecurityGroups": { "Ref": "SecurityGroups" },
                "InstanceType": "t2.micro",
                "IamInstanceProfile": { "Ref": "InstanceProfile" },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [ "\n", [
                            "#!/bin/bash -ev",

                            "adduser --disabled-password content-api",
                            "wget -NP /home/ubuntu/.ssh https://s3-eu-west-1.amazonaws.com/content-api-dist/authorized_keys",
                            "cd /home/content-api",
                            "mkdir logs",
                            "mkdir -p /etc/gu",

                            { "Fn::Join": [ "", [ "wget https://s3-eu-west-1.amazonaws.com/content-api-dist/content-api-dashboard/",{ "Ref": "Stage" }, "/content-api-dashboard/content-api-dashboard-0.1-SNAPSHOT.tgz" ] ] },
                            { "Fn::Join": [ "", [ "wget https://s3-eu-west-1.amazonaws.com/content-api-dist/content-api-dashboard/",{ "Ref": "Stage" }, "/content-api-dashboard/content-api-dashboard.conf" ] ] },
                            "tar -xvf content-api-dashboard-0.1-SNAPSHOT.tgz",
                            "rm content-api-dashboard-0.1-SNAPSHOT.tgz",
                            "mv content-api-dashboard-0.1-SNAPSHOT content-api-dashboard",
                            "mv content-api-dashboard.conf /etc/init",
                            "chown -R content-api /home/content-api /etc/gu",
                            "chgrp -R content-api /home/content-api /etc/gu",
                            { "Fn::Join": [ "", [ "aws s3 cp s3://content-api-config/content-api-dashboard/",{ "Ref": "Stage" }, "/content-api-dashboard.conf /etc/gu/content-api-dashboard.conf" ] ] },

                            "start content-api-dashboard"
                        ] ]
                    }
                }
            }
        }
    },
    "Outputs": {
        "LaunchConfig": {
            "Value": { "Ref": "LaunchConfig" }
        }
    }
}
